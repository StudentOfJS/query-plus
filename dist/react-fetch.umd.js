(function(n,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("react"),require("idb-keyval")):typeof define=="function"&&define.amd?define(["exports","react","idb-keyval"],t):(n=typeof globalThis!="undefined"?globalThis:n||self,t(n["react-fetch"]={},n.React,n.idbKeyval))})(this,function(n,t,r){"use strict";var X=Object.defineProperty,V=Object.defineProperties;var E=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable;var B=(n,t,r)=>t in n?X(n,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[t]=r,u=(n,t)=>{for(var r in t||(t={}))M.call(t,r)&&B(n,r,t[r]);if(W)for(var r of W(t))D.call(t,r)&&B(n,r,t[r]);return n},b=(n,t)=>V(n,E(t));const Z="dmFyIHU9T2JqZWN0LmRlZmluZVByb3BlcnR5LGg9T2JqZWN0LmRlZmluZVByb3BlcnRpZXM7dmFyIGc9T2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnM7dmFyIG49T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9sczt2YXIgZD1PYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LHc9T2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZTt2YXIgbD0ocyx0LGUpPT50IGluIHM/dShzLHQse2VudW1lcmFibGU6ITAsY29uZmlndXJhYmxlOiEwLHdyaXRhYmxlOiEwLHZhbHVlOmV9KTpzW3RdPWUsYz0ocyx0KT0+e2Zvcih2YXIgZSBpbiB0fHwodD17fSkpZC5jYWxsKHQsZSkmJmwocyxlLHRbZV0pO2lmKG4pZm9yKHZhciBlIG9mIG4odCkpdy5jYWxsKHQsZSkmJmwocyxlLHRbZV0pO3JldHVybiBzfSxpPShzLHQpPT5oKHMsZyh0KSk7KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO3NlbGYuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIscz0+e2NvbnN0e3R5cGU6dH09cy5kYXRhO2xldCBlPW5ldyBBYm9ydENvbnRyb2xsZXIsYT1lLnNpZ25hbDtpZih0PT09ImNhbmNlbCImJmUuc2lnbmFsLmFib3J0KCksdD09PSJmZXRjaCIpe2NvbnN0e3VybDpmLG9wdGlvbnM6b309cy5kYXRhO2ZldGNoKGYsbz9pKGMoe30sbykse3NpZ25hbDphfSk6e3NpZ25hbDphfSkudGhlbihyPT57aWYoIXIub2t8fHIuc3RhdHVzPT09NDA0KXRocm93IG5ldyBFcnJvcihgSFRUUCBlcnJvciEgU3RhdHVzOiAke3Iuc3RhdHVzfWApO2lmKHIuc3RhdHVzPT09NDAzKXRocm93IG5ldyBFcnJvcigiVW5hdXRob3JpemVkISIpO3JldHVybiByLmpzb24oKX0pLnRoZW4ocj0+e3NlbGYucG9zdE1lc3NhZ2Uoe3R5cGU6InN1Y2Nlc3MiLGRhdGE6cn0pLGU9dm9pZCAwfSkuY2F0Y2gocj0+e3NlbGYucG9zdE1lc3NhZ2Uoe3R5cGU6ci5tZXNzYWdlfHwiVW5rbm93biBlcnJvciJ9KX0pfX0pfSkoKTsK",g=typeof window!="undefined"&&window.Blob&&new Blob([atob(Z)],{type:"text/javascript;charset=utf-8"});function S(){const e=g&&(window.URL||window.webkitURL).createObjectURL(g);try{return e?new Worker(e,{}):new Worker("data:application/javascript;base64,"+Z,{type:"module"})}finally{e&&(window.URL||window.webkitURL).revokeObjectURL(e)}}const Y="usestore-db",H="usestore-db",w=(e=!0,l=H)=>{const c=t.useRef();return t.useEffect(()=>(c.current=r.createStore(Y,l),()=>{!e&&r.clear(c.current),c.current=void 0}),[]),{del:o=>r.del(o,c.current),get:o=>r.get(o,c.current),getMany:o=>r.getMany(o,c.current),set:(o,s)=>r.set(o,s,c.current),setMany:o=>r.setMany(o,c.current),update:(o,s)=>r.update(o,s,c.current)}},N=24*60*60*1e3;function y(e){e==null||e.postMessage({type:"cancel"}),e==null||e.terminate(),e=void 0}function I(e,l){switch(l.type){case"nuke":return b(u({},e),{nuked:!0});case"pre-load":return b(u({},e),{data:l.data});case"data":return b(u({},e),{data:l.data,loading:!1,nuked:!1,error:void 0});case"clearError":return b(u({},e),{error:void 0});case"error":return b(u({},e),{error:l.error,loading:!1});case"loading":return b(u({},e),{loading:l.loading});default:return e}}const J={data:void 0,error:void 0,loading:!1,nuked:!1,update:!0};function k(){const{del:e,get:l,set:c}=w(),[o,s]=t.useReducer(I,J),f=t.useRef({worker:void 0,controller:new AbortController});let{worker:p,controller:R}=f.current;return t.useEffect(()=>{var i,a,m;return!window&&!((m=(a=(i=f==null?void 0:f.current)==null?void 0:i.controller)==null?void 0:a.signal)!=null&&m.aborted)&&(s({type:"loading",loading:!1}),s({type:"error",error:new Error("window is not defined")}),y(p)),()=>{y(p)}},[window,f.current.controller]),u({fetchWorker:async({url:i,fetchOptions:a,cache:m=!1,maxAge:U=N})=>{y(p);let h=((a==null?void 0:a.method)||"GET").toLowerCase()==="get",z=h?await l(i.toString()).then(d=>d!=null&&d.timestamp?(d==null?void 0:d.timestamp)+U<=Date.now()?(e(i.toString()),!0):(console.log("cache hit",i.toString()),s({type:m?"data":"pre-load",data:d==null?void 0:d.data}),!m):!0):!0;window&&z&&(h&&e(i.toString()),p=new S,s({type:"loading",loading:!0}),p.postMessage({type:"fetch",url:i,fetchOptions:a}),p.addEventListener("message",({data:{data:d,type:G}})=>{var L;if(!((L=R==null?void 0:R.signal)!=null&&L.aborted))if(G==="success"){if(s({type:"data",data:d,url:i,fetchOptions:a}),m&&h){let T={timestamp:Date.now(),data:d};c(i.toString(),T).then(()=>{console.log("saved data")}).catch(()=>{console.error("couldn't access indexedDB to save data")})}}else s({type:"error",error:new Error(G)});y(p)}))}},o)}n.useFetch=k,n.useStore=w,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
