(function(d,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("react"),require("idb-keyval")):typeof define=="function"&&define.amd?define(["exports","react","idb-keyval"],t):(d=typeof globalThis!="undefined"?globalThis:d||self,t(d["query-plus"]={},d.React,d.idbKeyval))})(this,function(d,t,n){"use strict";var Q=Object.defineProperty,O=Object.defineProperties;var D=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var q=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable;var N=(d,t,n)=>t in d?Q(d,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):d[t]=n,b=(d,t)=>{for(var n in t||(t={}))q.call(t,n)&&N(d,n,t[n]);if(V)for(var n of V(t))A.call(t,n)&&N(d,n,t[n]);return d},Y=(d,t)=>O(d,D(t));const J="dmFyIEM9T2JqZWN0LmRlZmluZVByb3BlcnR5LFQ9T2JqZWN0LmRlZmluZVByb3BlcnRpZXM7dmFyIE09T2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnM7dmFyIHk9T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9sczt2YXIgTz1PYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LFM9T2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZTt2YXIgaD0oaSxzLGEpPT5zIGluIGk/QyhpLHMse2VudW1lcmFibGU6ITAsY29uZmlndXJhYmxlOiEwLHdyaXRhYmxlOiEwLHZhbHVlOmF9KTppW3NdPWEsQT0oaSxzKT0+e2Zvcih2YXIgYSBpbiBzfHwocz17fSkpTy5jYWxsKHMsYSkmJmgoaSxhLHNbYV0pO2lmKHkpZm9yKHZhciBhIG9mIHkocykpUy5jYWxsKHMsYSkmJmgoaSxhLHNbYV0pO3JldHVybiBpfSxkPShpLHMpPT5UKGksTShzKSk7KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IGk9dD0+dHlwZW9mIHQ9PSJvYmplY3QiJiYhQXJyYXkuaXNBcnJheSh0KSYmdCE9PW51bGwscz0odCxyLG49e30pPT4oT2JqZWN0LmtleXModCkuZm9yRWFjaChlPT57bGV0IG89cj9yKyIuIitlOmU7aSh0W2VdKT9zKHRbZV0sbyxuKTpuW29dPUFycmF5LmlzQXJyYXkodFtlXSk/dFtlXS5zb3J0KCk6dFtlXX0pLE9iamVjdC5lbnRyaWVzKG4pLnNvcnQoKSksYT10PT50LmZsYXRNYXAocj0+aShyKT9zKHIpOltyXSkuc29ydCgpLGc9dD0+e3ZhciByLG47cmV0dXJuKG49KHI9dD09bnVsbD92b2lkIDA6dC5tZXRob2QpPT1udWxsP3ZvaWQgMDpyLnRvVXBwZXJDYXNlKCkpIT1udWxsP246IkdFVCJ9LHc9KHQscixuKT0+e2xldCBlPUFycmF5LmlzQXJyYXkodCk/ImFycmF5Ijp0eXBlb2YgdCxvPUFycmF5LmlzQXJyYXkocik/ImFycmF5Ijp0eXBlb2YgcjtyZXR1cm4gZSE9PW8/ITE6ZSE9PSJvYmplY3QiJiZlIT09ImFycmF5Ij9lPT09bzpuJiZlPT09Im9iamVjdCI/bi5tYXAoYz0+dFtjXT09PXJbY10pLmV2ZXJ5KGM9PmMpOihlPT09ImFycmF5IiYmKHQ9YSh0KSxyPWEocikpLCFuJiZlPT09Im9iamVjdCImJih0PXModCkscj1zKHIpKSxKU09OLnN0cmluZ2lmeSh0KT09PUpTT04uc3RyaW5naWZ5KHIpKX0sRT10PT5uZXcgRnVuY3Rpb24oYHJldHVybiAke2RlY29kZVVSSSh0KX1gKSgpO3NlbGYuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsdD0+e2NvbnN0e3R5cGU6cn09dC5kYXRhO2xldCBuPW5ldyBBYm9ydENvbnRyb2xsZXIsZT1uPT1udWxsP3ZvaWQgMDpuLnNpZ25hbDtpZihyPT09ImNhbmNlbCImJihuPT1udWxsfHxuLmFib3J0KCkpLHI9PT0iZmV0Y2giKXtjb25zdHt1cmw6byxvcHRpb25zOmMsZXhpc3RpbmdEYXRhOm0sbWlkZGxld2FyZTpsfT10LmRhdGE7ZmV0Y2gobyxjP2QoQSh7fSxjKSx7c2lnbmFsOmV9KTp7c2lnbmFsOmV9KS50aGVuKGY9PntpZighZi5va3x8Zi5zdGF0dXM9PT00MDQpdGhyb3cgbmV3IEVycm9yKGBIVFRQIGVycm9yISBTdGF0dXM6ICR7Zi5zdGF0dXN9YCk7aWYoZi5zdGF0dXM9PT00MDMpdGhyb3cgbmV3IEVycm9yKCJVbmF1dGhvcml6ZWQhIik7cmV0dXJuIGYuanNvbigpfSkudGhlbihmPT57bCYmKGY9RShsKShmKSk7bGV0IHA9ZyhjKSx1PXcobSxmKTtzZWxmLnBvc3RNZXNzYWdlKHt0eXBlOnU/IkNBQ0hFRCI6cCxkYXRhOiF1JiZmfSl9KS5jYXRjaChmPT57c2VsZi5wb3N0TWVzc2FnZSh7dHlwZTpmLm1lc3NhZ2V8fCJVbmtub3duIGVycm9yIn0pfSl9fSl9KSgpOwo=",P=typeof window!="undefined"&&window.Blob&&new Blob([atob(J)],{type:"text/javascript;charset=utf-8"});function H(){const e=P&&(window.URL||window.webkitURL).createObjectURL(P);try{return e?new Worker(e,{}):new Worker("data:application/javascript;base64,"+J,{type:"module"})}finally{e&&(window.URL||window.webkitURL).revokeObjectURL(e)}}const L="usestore-db",x="usestore-db",I=e=>{const{persistData:l,storeName:Z}=b({persistData:!0,storeName:x},e),i=t.useRef();return t.useEffect(()=>(i.current=n.createStore(L,Z),()=>{!l&&n.clear(i.current),i.current=void 0}),[]),{__dangerouslyNukeAllStores:()=>{indexedDB.deleteDatabase(L)},del:c=>n.del(c,i.current),get:c=>n.get(c,i.current),getMany:c=>n.getMany(c,i.current),set:(c,m)=>n.set(c,m,i.current),setMany:c=>n.setMany(c,i.current),update:(c,m)=>n.update(c,m,i.current)}},z={data:void 0,error:void 0,loading:!1,update:!0};function F(e,l){switch(l.type){case"pre-load":return Y(b({},e),{data:l.data});case"data":return Y(b({},e),{data:l.data,loading:!1,error:void 0});case"error":return Y(b({},e),{error:l.error,loading:!1});case"loading":return Y(b({},e),{loading:l.loading});default:return e}}const E=24*60*60*1e3;function R(e){e==null||e.postMessage({type:"cancel"}),e==null||e.terminate(),e=void 0}const f=(e,l)=>l?e+l<Date.now():!0,g=e=>typeof e=="object"&&!Array.isArray(e)&&e!==null,k=e=>{var l,Z;return(Z=(l=e==null?void 0:e.method)==null?void 0:l.toUpperCase())!=null?Z:"GET"},j=e=>encodeURI(e.toString());function v(){const{del:e,get:l,set:Z,update:i}=I(),[c,m]=t.useReducer(F,z),r=t.useRef(),W=async({url:s,fetchOptions:h,maxAge:S=E,middleware:X})=>{let p=r.current;m({type:"loading",loading:!0});let T=k(h);T==="DELETE"&&e(s.toString()),T==="GET"&&l(s.toString()).then(o=>{if(!o)throw new Error("no value found in db");f(S,o==null?void 0:o.timestamp)?e(s.toString()):m({type:"pre-load",data:o==null?void 0:o.data})}).catch(()=>{m({type:"pre-load",data:void 0})}),p==null||p.addEventListener("message",({data:{type:o,data:y}})=>{if(o==="DELETE"||o==="CACHED")m({type:"loading",loading:!1});else if(o==="GET"){m({type:"data",data:y});let a={timestamp:Date.now(),maxAge:S,data:y};Z(s.toString(),a).then(()=>{console.log("saved data")}).catch(()=>{console.error("couldn't access indexedDB to save data")})}else o==="PUT"||o==="POST"?i(s.toString(),u=>{let a=Date.now(),G=g(y)&&g(u==null?void 0:u.data)?b(b({},u.data),y):y;return m({type:"data",data:G}),{timestamp:a,maxAge:S,data:G}}).then(()=>{console.log("updated data")}).catch(()=>{m({type:"loading",loading:!1}),console.error("save to indexedDB failed")}):m({type:"error",error:new Error(o)})});let K=X?j(X):void 0;p==null||p.postMessage({type:"fetch",url:s,fetchOptions:h,existingData:c.data,middleware:K})};return t.useEffect(()=>(r.current=new H,()=>{R(r.current)}),[]),b({fetchWorker:W},c)}const w="dmFyIG09T2JqZWN0LmRlZmluZVByb3BlcnR5LE89T2JqZWN0LmRlZmluZVByb3BlcnRpZXM7dmFyIFM9T2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnM7dmFyIGQ9T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9sczt2YXIgdj1PYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LE09T2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZTt2YXIgZz0oaSxhLG4pPT5hIGluIGk/bShpLGEse2VudW1lcmFibGU6ITAsY29uZmlndXJhYmxlOiEwLHdyaXRhYmxlOiEwLHZhbHVlOm59KTppW2FdPW4saD0oaSxhKT0+e2Zvcih2YXIgbiBpbiBhfHwoYT17fSkpdi5jYWxsKGEsbikmJmcoaSxuLGFbbl0pO2lmKGQpZm9yKHZhciBuIG9mIGQoYSkpTS5jYWxsKGEsbikmJmcoaSxuLGFbbl0pO3JldHVybiBpfSxwPShpLGEpPT5PKGksUyhhKSk7KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IGk9YXN5bmMoe2ZuOnQsdmFsaWRhdGU6ZSxpbnRlcnZhbDpzLG1heEF0dGVtcHRzOnIsYXR0ZW1wdHM6Yz0wfSk9Pnthc3luYyBmdW5jdGlvbiBmKHUseSl7dHJ5e2NvbnN0IGw9YXdhaXQgdCgpO2lmKGMrKyxlKGwpKXJldHVybiB1KGwpO2lmKHImJmM9PT1yKXJldHVybiB5KG5ldyBFcnJvcigiRXhjZWVkZWQgbWF4IGF0dGVtcHRzIikpO2F3YWl0IHNldFRpbWVvdXQoZixzLHUseSl9Y2F0Y2gobCl7Y29uc29sZS5lcnJvcihgcG9sbGluZyBFcnJvcjogJHsobD09bnVsbD92b2lkIDA6bC5tZXNzYWdlKXx8ImNvbm5lY3Rpb24gZmFpbGVkIn1gKX19cmV0dXJuIG5ldyBQcm9taXNlKGYpfSxhPXQ9PnR5cGVvZiB0PT0ib2JqZWN0IiYmIUFycmF5LmlzQXJyYXkodCkmJnQhPT1udWxsLG49KHQsZSxzPXt9KT0+KE9iamVjdC5rZXlzKHQpLmZvckVhY2gocj0+e2xldCBjPWU/ZSsiLiIrcjpyO2EodFtyXSk/bih0W3JdLGMscyk6c1tjXT1BcnJheS5pc0FycmF5KHRbcl0pP3Rbcl0uc29ydCgpOnRbcl19KSxPYmplY3QuZW50cmllcyhzKS5zb3J0KCkpLEE9dD0+dC5mbGF0TWFwKGU9PmEoZSk/bihlKTpbZV0pLnNvcnQoKSx3PSh0LGUscyk9PntsZXQgcj1BcnJheS5pc0FycmF5KHQpPyJhcnJheSI6dHlwZW9mIHQsYz1BcnJheS5pc0FycmF5KGUpPyJhcnJheSI6dHlwZW9mIGU7cmV0dXJuIHIhPT1jPyExOnIhPT0ib2JqZWN0IiYmciE9PSJhcnJheSI/cj09PWM6cyYmcj09PSJvYmplY3QiP3MubWFwKGY9PnRbZl09PT1lW2ZdKS5ldmVyeShmPT5mKToocj09PSJhcnJheSImJih0PUEodCksZT1BKGUpKSwhcyYmcj09PSJvYmplY3QiJiYodD1uKHQpLGU9bihlKSksSlNPTi5zdHJpbmdpZnkodCk9PT1KU09OLnN0cmluZ2lmeShlKSl9O3NlbGYuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsdD0+e2NvbnN0e3R5cGU6ZX09dC5kYXRhO2xldCBzPW5ldyBBYm9ydENvbnRyb2xsZXIscj1zPT1udWxsP3ZvaWQgMDpzLnNpZ25hbDtpZihlPT09ImNhbmNlbCImJihzPT1udWxsfHxzLmFib3J0KCkpLGU9PT0icG9sbCIpe2NvbnN0e3VybDpjLGZldGNoT3B0aW9uczpmLGludGVydmFsOnUsbWF4QXR0ZW1wdHM6eSxjdXJyZW50SlNPTjpsLGNvbXBhcmVLZXlzOkV9PXQuZGF0YTtpKHtmbjooKT0+ZmV0Y2goYyxmP3AoaCh7fSxmKSx7c2lnbmFsOnJ9KTp7c2lnbmFsOnJ9KS50aGVuKG89PntpZighby5va3x8by5zdGF0dXM9PT00MDQpdGhyb3cgbmV3IEVycm9yKGBIVFRQIGVycm9yISBTdGF0dXM6ICR7by5zdGF0dXN9YCk7aWYoby5zdGF0dXM9PT00MDMpdGhyb3cgbmV3IEVycm9yKCJVbmF1dGhvcml6ZWQhIik7cmV0dXJuIG8uanNvbigpfSksaW50ZXJ2YWw6dSxtYXhBdHRlbXB0czp5LHZhbGlkYXRlOm89PiF3KGwsbyxFKX0pLnRoZW4obz0+e3NlbGYucG9zdE1lc3NhZ2Uoe3R5cGU6InN1Y2Nlc3MiLGRhdGE6b30pLHM9dm9pZCAwfSkuY2F0Y2gobz0+e3NlbGYucG9zdE1lc3NhZ2Uoe3R5cGU6by5tZXNzYWdlfHwiVW5rbm93biBlcnJvciJ9KX0pfX0pfSkoKTsK",B=typeof window!="undefined"&&window.Blob&&new Blob([atob(w)],{type:"text/javascript;charset=utf-8"});function C(){const e=B&&(window.URL||window.webkitURL).createObjectURL(B);try{return e?new Worker(e,{}):new Worker("data:application/javascript;base64,"+w,{type:"module"})}finally{e&&(window.URL||window.webkitURL).revokeObjectURL(e)}}function M(){const{del:e,get:l,set:Z}=I(),[i,c]=t.useReducer(F,U);let r=t.useRef(new C).current;const W=async({url:s,fetchOptions:h,interval:S,maxAttempts:X,currentJSON:p,compareKeys:T})=>{var o,y,u;if(k(h)!=="GET")return c({type:"error",error:new Error("method must be GET to poll")});let K={};try{let a=await l(s.toString());f((o=a.maxAge)!=null?o:0,(y=a.timestamp)!=null?y:0)&&e(s.toString()).catch(G=>{console.error(G)}),K=(u=a.data)!=null?u:{}}catch(a){console.error(a)}r.postMessage({type:"poll",url:s,fetchOptions:h,interval:S,maxAttempts:X,currentJSON:p,compareKeys:T}),r.addEventListener("message",({data:{data:a,type:G}})=>{})};return t.useEffect(()=>(window||(c({type:"loading",loading:!1}),c({type:"error",error:new Error("window is not defined")}),R(r)),()=>{R(r)}),[window]),b({pollWorker:W},i)}const U={data:void 0,error:void 0,loading:!1,update:!0};d.useFetch=v,d.usePolling=M,d.useStore=I,Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
