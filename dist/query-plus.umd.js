(function(n,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("react"),require("idb-keyval")):typeof define=="function"&&define.amd?define(["exports","react","idb-keyval"],t):(n=typeof globalThis!="undefined"?globalThis:n||self,t(n["query-plus"]={},n.React,n.idbKeyval))})(this,function(n,t,d){"use strict";var M=Object.defineProperty,D=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var w=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var F=(n,t,d)=>t in n?M(n,t,{enumerable:!0,configurable:!0,writable:!0,value:d}):n[t]=d,r=(n,t)=>{for(var d in t||(t={}))w.call(t,d)&&F(n,d,t[d]);if(L)for(var d of L(t))O.call(t,d)&&F(n,d,t[d]);return n},b=(n,t)=>D(n,j(t));const T="dmFyIEM9T2JqZWN0LmRlZmluZVByb3BlcnR5LFQ9T2JqZWN0LmRlZmluZVByb3BlcnRpZXM7dmFyIE09T2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnM7dmFyIHk9T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9sczt2YXIgTz1PYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LFM9T2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZTt2YXIgaD0oaSxzLGEpPT5zIGluIGk/QyhpLHMse2VudW1lcmFibGU6ITAsY29uZmlndXJhYmxlOiEwLHdyaXRhYmxlOiEwLHZhbHVlOmF9KTppW3NdPWEsQT0oaSxzKT0+e2Zvcih2YXIgYSBpbiBzfHwocz17fSkpTy5jYWxsKHMsYSkmJmgoaSxhLHNbYV0pO2lmKHkpZm9yKHZhciBhIG9mIHkocykpUy5jYWxsKHMsYSkmJmgoaSxhLHNbYV0pO3JldHVybiBpfSxkPShpLHMpPT5UKGksTShzKSk7KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IGk9dD0+dHlwZW9mIHQ9PSJvYmplY3QiJiYhQXJyYXkuaXNBcnJheSh0KSYmdCE9PW51bGwscz0odCxyLG49e30pPT4oT2JqZWN0LmtleXModCkuZm9yRWFjaChlPT57bGV0IG89cj9yKyIuIitlOmU7aSh0W2VdKT9zKHRbZV0sbyxuKTpuW29dPUFycmF5LmlzQXJyYXkodFtlXSk/dFtlXS5zb3J0KCk6dFtlXX0pLE9iamVjdC5lbnRyaWVzKG4pLnNvcnQoKSksYT10PT50LmZsYXRNYXAocj0+aShyKT9zKHIpOltyXSkuc29ydCgpLGc9dD0+e3ZhciByLG47cmV0dXJuKG49KHI9dD09bnVsbD92b2lkIDA6dC5tZXRob2QpPT1udWxsP3ZvaWQgMDpyLnRvVXBwZXJDYXNlKCkpIT1udWxsP246IkdFVCJ9LHc9KHQscixuKT0+e2xldCBlPUFycmF5LmlzQXJyYXkodCk/ImFycmF5Ijp0eXBlb2YgdCxvPUFycmF5LmlzQXJyYXkocik/ImFycmF5Ijp0eXBlb2YgcjtyZXR1cm4gZSE9PW8/ITE6ZSE9PSJvYmplY3QiJiZlIT09ImFycmF5Ij9lPT09bzpuJiZlPT09Im9iamVjdCI/bi5tYXAoYz0+dFtjXT09PXJbY10pLmV2ZXJ5KGM9PmMpOihlPT09ImFycmF5IiYmKHQ9YSh0KSxyPWEocikpLCFuJiZlPT09Im9iamVjdCImJih0PXModCkscj1zKHIpKSxKU09OLnN0cmluZ2lmeSh0KT09PUpTT04uc3RyaW5naWZ5KHIpKX0sRT10PT5uZXcgRnVuY3Rpb24oYHJldHVybiAke2RlY29kZVVSSSh0KX1gKSgpO3NlbGYuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsdD0+e2NvbnN0e3R5cGU6cn09dC5kYXRhO2xldCBuPW5ldyBBYm9ydENvbnRyb2xsZXIsZT1uPT1udWxsP3ZvaWQgMDpuLnNpZ25hbDtpZihyPT09ImNhbmNlbCImJihuPT1udWxsfHxuLmFib3J0KCkpLHI9PT0iZmV0Y2giKXtjb25zdHt1cmw6byxvcHRpb25zOmMsZXhpc3RpbmdEYXRhOm0sbWlkZGxld2FyZTpsfT10LmRhdGE7ZmV0Y2gobyxjP2QoQSh7fSxjKSx7c2lnbmFsOmV9KTp7c2lnbmFsOmV9KS50aGVuKGY9PntpZighZi5va3x8Zi5zdGF0dXM9PT00MDQpdGhyb3cgbmV3IEVycm9yKGBIVFRQIGVycm9yISBTdGF0dXM6ICR7Zi5zdGF0dXN9YCk7aWYoZi5zdGF0dXM9PT00MDMpdGhyb3cgbmV3IEVycm9yKCJVbmF1dGhvcml6ZWQhIik7cmV0dXJuIGYuanNvbigpfSkudGhlbihmPT57bCYmKGY9RShsKShmKSk7bGV0IHA9ZyhjKSx1PXcobSxmKTtzZWxmLnBvc3RNZXNzYWdlKHt0eXBlOnU/IkNBQ0hFRCI6cCxkYXRhOiF1JiZmfSl9KS5jYXRjaChmPT57c2VsZi5wb3N0TWVzc2FnZSh7dHlwZTpmLm1lc3NhZ2V8fCJVbmtub3duIGVycm9yIn0pfSl9fSl9KSgpOwo=",Y=typeof window!="undefined"&&window.Blob&&new Blob([atob(T)],{type:"text/javascript;charset=utf-8"});function P(){const e=Y&&(window.URL||window.webkitURL).createObjectURL(Y);try{return e?new Worker(e,{}):new Worker("data:application/javascript;base64,"+T,{type:"module"})}finally{e&&(window.URL||window.webkitURL).revokeObjectURL(e)}}const X="usestore-db",G="usestore-db",I=e=>{const{persistData:c,storeName:l}=r({persistData:!0,storeName:G},e),o=t.useRef();return t.useEffect(()=>(o.current=d.createStore(X,l),()=>{!c&&d.clear(o.current),o.current=void 0}),[]),{__dangerouslyNukeAllStores:()=>{indexedDB.deleteDatabase(X)},del:s=>d.del(s,o.current),get:s=>d.get(s,o.current),getMany:s=>d.getMany(s,o.current),set:(s,a)=>d.set(s,a,o.current),setMany:s=>d.setMany(s,o.current),update:(s,a)=>d.update(s,a,o.current)}},J={data:void 0,error:void 0,loading:!1,update:!0};function V(e,c){switch(c.type){case"pre-load":return b(r({},e),{data:c.data});case"data":return b(r({},e),{data:c.data,loading:!1,error:void 0});case"error":return b(r({},e),{error:c.error,loading:!1});case"loading":return b(r({},e),{loading:c.loading});default:return e}}const k=24*60*60*1e3;function H(e){e==null||e.postMessage({type:"cancel"}),e==null||e.terminate(),e=void 0}const x=(e,c)=>c?e+c<Date.now():!0,f=e=>typeof e=="object"&&!Array.isArray(e)&&e!==null,B=e=>{var c,l;return(l=(c=e==null?void 0:e.method)==null?void 0:c.toUpperCase())!=null?l:"GET"},E=e=>encodeURI(e.toString());function N(){const{del:e,get:c,set:l,update:o}=I(),[s,a]=t.useReducer(V,J),h=t.useRef(),z=async({url:m,fetchOptions:R,maxAge:S=k,middleware:g})=>{let u=h.current;a({type:"loading",loading:!0});let W=B(R);W==="DELETE"&&e(m.toString()),W==="GET"&&c(m.toString()).then(i=>{if(!i)throw new Error("no value found in db");x(S,i==null?void 0:i.timestamp)?e(m.toString()):a({type:"pre-load",data:i==null?void 0:i.data})}).catch(()=>{a({type:"pre-load",data:void 0})}),u==null||u.addEventListener("message",({data:{type:i,data:p}})=>{if(i==="DELETE"||i==="CACHED")a({type:"loading",loading:!1});else if(i==="GET"){a({type:"data",data:p});let Z={timestamp:Date.now(),maxAge:S,data:p};l(m.toString(),Z).then(()=>{console.log("saved data")}).catch(()=>{console.error("couldn't access indexedDB to save data")})}else i==="PUT"||i==="POST"?o(m.toString(),y=>{let Z=Date.now(),K=f(p)&&f(y==null?void 0:y.data)?r(r({},y.data),p):p;return a({type:"data",data:K}),{timestamp:Z,maxAge:S,data:K}}).then(()=>{console.log("updated data")}).catch(()=>{a({type:"loading",loading:!1}),console.error("save to indexedDB failed")}):a({type:"error",error:new Error(i)})});let C=g?E(g):void 0;u==null||u.postMessage({type:"fetch",url:m,fetchOptions:R,existingData:s.data,middleware:C})};return t.useEffect(()=>(h.current=new P,()=>{H(h.current)}),[]),r({fetchWorker:z},s)}n.useFetch=N,n.useStore=I,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
